<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1nuo 评测数据中心</title>
    <link rel="shortcut icon" href="https://img.1nuo.me/img/favicon.webp">
    <style>
        :root {
            --primary-color: #4f46e5; 
            --accent-color: #f1c40f;
            --success-color: #10b981; 
            --bg-color: #f8fafc;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); margin: 0; padding: 0; padding-bottom: 50px; }
        
        .page-header {
            width: 100%; height: 220px;
            background: url('https://img.1nuo.me/img/academicbanner.webp') center/cover no-repeat;
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; /* 居中显示 */
            padding-bottom: 40px; /* 关键：新增底部边距，把文字往上推，防止被遮挡 */
            color: #fff; position: relative;
            box-sizing: border-box;
        }

        .page-header::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.4), rgba(0,0,0,0.1));
        }

        .back-link { 
            position: absolute; top: 20px; left: 20px; 
            color: #fff; text-decoration: none; font-size: 14px; font-weight: 500;
            display: flex; align-items: center; gap: 5px; z-index: 10;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .back-link:hover { color: var(--accent-color); transform: translateX(-3px); transition: 0.2s; }

        .page-header h1 {
            margin: 0; font-size: 28px; letter-spacing: 4px; color: var(--accent-color);
            text-shadow: 0 4px 12px rgba(0,0,0,0.6); z-index: 5; font-weight: 900;
        }
        .page-header p {
            margin-top: 8px; opacity: 0.9; font-size: 13px; letter-spacing: 1px;
            z-index: 5; font-weight: 300; color: #eee;
        }

        .db-status-bar {
            width: 92%; max-width: 500px; margin: -90px auto 15px auto;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            border-radius: 12px; padding: 10px 15px; border: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
            position: relative; z-index: 10; box-sizing: border-box;
        }
        .status-info { font-size: 12px; color: #64748b; display: flex; align-items: center; gap: 6px; }
        .status-dot { width: 8px; height: 8px; background: #cbd5e1; border-radius: 50%; }
        .status-dot.active { background: var(--success-color); box-shadow: 0 0 8px var(--success-color); }
        .btn-connect { 
            padding: 4px 10px; background: var(--primary-color); color: #fff; 
            border: none; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer;
        }

        .cloud-panel {
            width: 92%; max-width: 500px; margin: 0 auto 15px auto;
            background: #fff; border-radius: 12px; border: 1px solid #e2e8f0;
            position: relative; z-index: 10; box-sizing: border-box;
            overflow: hidden;
        }
        .cloud-header { 
            padding: 10px 15px; background: #f8fafc; font-size: 12px; font-weight: bold; 
            color: var(--primary-color); cursor: pointer; display: flex; justify-content: space-between;
        }
        .cloud-content { padding: 15px; display: none; }
        .cloud-content.show { display: block; }
        .cloud-content input { margin-bottom: 10px; padding: 8px; border-radius: 6px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; font-size: 12px; }

        .card { 
            background: #fff; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); 
            width: 92%; max-width: 500px; margin: 0 auto;
            position: relative; z-index: 5; padding: 30px;
            border: 1px solid rgba(255,255,255,0.8); box-sizing: border-box;
        }

        h2 { margin-top: 0; color: #1e293b; border-bottom: 2px solid var(--primary-color); padding-bottom: 12px; font-size: 18px; display: flex; justify-content: space-between; align-items: center; }
        
        select, input, textarea { width: 100%; padding: 12px; margin: 8px 0 18px 0; border: 1px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-size: 14px; outline: none; transition: 0.3s; }
        input:focus, textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        label { font-size: 13px; font-weight: 700; color: #475569; display: block; }
        
        .score-item { background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #f1f5f9; }
        .row { display: flex; gap: 10px; align-items: center; }
        .row input { flex: 2; margin: 0; }
        .row select { flex: 1.5; margin: 0; }
        .res-tag { flex: 1; text-align: right; font-weight: 900; color: var(--primary-color); font-size: 18px; }
        
        .tag-item { display: flex; gap: 8px; margin-bottom: 8px; }
        .btn-add { width: 100%; padding: 10px; background: #fff; color: var(--primary-color); border: 2px dashed #e2e8f0; border-radius: 10px; cursor: pointer; margin-bottom: 20px; transition: 0.2s; font-weight: bold; }
        
        .result { background: #1e293b; color: #fff; padding: 25px; border-radius: 18px; margin-top: 30px; }
        .res-line { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: #94a3b8; }
        .final-score { font-size: 32px; color: var(--accent-color); font-weight: 900; text-shadow: 0 2px 10px rgba(241, 196, 15, 0.3); }
        
        /* 底部按钮组 */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 15px 0; }
        .btn-gen { padding: 12px 5px; background: #475569; color: #fff; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 12px; }
        .btn-gen.local { background: var(--primary-color); }
        .btn-gen.cloud { background: #24292f; }
        .btn-gen:active { transform: scale(0.97); }
        
        textarea#out-json { background: #0f172a; color: #10b981; font-family: 'Fira Code', monospace; font-size: 11px; height: 100px; border: none; padding: 10px; }
        #dev-msg { display: none; padding: 50px 20px; text-align: center; background: #fffbeb; border: 2px dashed #f59e0b; border-radius: 15px; color: #b45309; font-weight: bold; margin: 20px 0; }
        .time-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    </style>
</head>
<body>

<div class="page-header">
    <a href="/rate/" class="back-link">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        返回主页
    </a>
    <h1>评测数据中心</h1>
    <p>1NUO RATING SYSTEM • 数字化管理</p>
</div>

<div class="db-status-bar">
    <div class="status-info">
        <div id="status-dot" class="status-dot"></div>
        <span id="status-text">未关联本地 JSON</span>
    </div>
    <button class="btn-connect" onclick="connectDB()">关联本地</button>
</div>

<div class="cloud-panel">
    <div class="cloud-header" onclick="toggleCloud()">
        <span>☁️ 云端同步设置 (GitHub API)</span>
        <span id="cloud-arrow">▼</span>
    </div>
    <div id="cloud-content" class="cloud-content">
        <input type="text" id="gh-user" placeholder="GitHub 用户名" oninput="saveCloudConfig()">
        <input type="text" id="gh-repo" placeholder="仓库名 (如 blog)" oninput="saveCloudConfig()">
        <input type="password" id="gh-token" placeholder="Personal Access Token (ghp_...)" oninput="saveCloudConfig()">
        <p style="font-size: 10px; color: #94a3b8; margin: 0;">* 配置仅保存在本地浏览器中</p>
    </div>
</div>

<div class="card">
    <div class="card-inner">
        <h2>🛠️ 决策引擎 
            <select id="nuo-category" style="width:auto; margin:0; border:none; background:transparent; font-weight:bold; color:var(--primary-color); cursor:pointer;" onchange="handleCategoryChange()">
                <option value="attractions">🏛️ 景点模式</option>
                <option value="drinks">🍹 饮品模式</option>
            </select>
        </h2>

        <div id="dev-msg">🍹 饮品评测维度还在开发中...</div>

        <div id="main-form">
            <div class="time-row">
                <div>
                    <label>识别 ID (拼音/唯一)</label>
                    <input type="text" id="in-id" placeholder="如: wangushi" oninput="updateAll()">
                </div>
                <div>
                    <label>项目名称</label>
                    <input type="text" id="in-name" placeholder="输入名称..." oninput="updateAll()">
                </div>
            </div>

            <label>专属评语</label>
            <input type="text" id="in-slogan" placeholder="例如：白日依山尽，黄河入海流">

            <div id="dims-container"></div>

            <div style="margin-top:20px; border-top:1px solid #f1f5f9; padding-top:15px;">
                <label>🏷️ Tag</label>
                <div id="tag-list"></div>
                <button class="btn-add" onclick="addTagField()">+ 添加新标签</button>
            </div>

            <label>📍 地点信息</label>
            <input type="text" id="in-loc" placeholder="景点地址">

            <div class="time-row">
                <div>
                    <label>🗓️ 游览日期</label>
                    <input type="text" id="in-vtime" placeholder="2026.2.18">
                </div>
                <div>
                    <label>✍️ 记录日期</label>
                    <input type="text" id="in-rtime">
                </div>
            </div>

            <label>💬 简评心得</label>
            <textarea id="in-review" rows="4" placeholder="写下你的感受..."></textarea>

            <label>🖼️ 现场照片 (直接粘贴 PicGo 图床链接，每行一个)</label>
            <textarea id="in-imgs" rows="3" placeholder="https://img.1nuo.me/rate/rateimg/xxx.webp&#10;支持直接粘贴，代码会自动清洗格式" oninput="updateAll()"></textarea>

            <div class="result">
                <div class="res-line"><span>加权基础分:</span><span id="v-base">0.00</span></div>
                <div class="res-line"><span>综合得分 / 评级:</span></div>
                <div style="display: flex; align-items: baseline; gap: 10px;">
                    <span class="final-score" id="v-final">0.00</span>
                    <span class="final-score" id="v-level" style="font-size: 24px;">D</span>
                </div>
                
                <div class="btn-group">
                    <button class="btn-gen" onclick="generateJSON()">代码预览</button>
                    <button class="btn-gen local" onclick="saveToLocal()">💾 本地写入</button>
                    <button class="btn-gen cloud" id="btn-cloud" onclick="saveToCloud()">🚀 云端同步</button>
                </div>
                
                <textarea id="out-json" readonly placeholder="代码预览..."></textarea>
            </div>
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        attractions: { w: [0.25, 0.3, 0.25, 0.2], l: ["建筑视觉", "文化共鸣", "游览体验", "质价比"], keys: ['architecture', 'culture', 'experience', 'value'] }
    };
    const TAG_MAP = { 'S': 0.3, 'A': 0.2, 'B': 0.1, 'C': 0.05 };
    let fileHandle = null;

    function toggleCloud() {
        const content = document.getElementById('cloud-content');
        const arrow = document.getElementById('cloud-arrow');
        content.classList.toggle('show');
        arrow.innerText = content.classList.contains('show') ? '▲' : '▼';
    }

    function saveCloudConfig() {
        localStorage.setItem('nuo_gh_user', document.getElementById('gh-user').value);
        localStorage.setItem('nuo_gh_repo', document.getElementById('gh-repo').value);
        localStorage.setItem('nuo_gh_token', document.getElementById('gh-token').value);
    }

    function loadCloudConfig() {
        document.getElementById('gh-user').value = localStorage.getItem('nuo_gh_user') || '';
        document.getElementById('gh-repo').value = localStorage.getItem('nuo_gh_repo') || '';
        document.getElementById('gh-token').value = localStorage.getItem('nuo_gh_token') || '';
    }

    async function saveToCloud() {
        const user = document.getElementById('gh-user').value;
        const repo = document.getElementById('gh-repo').value;
        const token = document.getElementById('gh-token').value;
        const path = "source/rate/rate_data.json";

        if (!user || !repo || !token) { alert("❌ 请先完成云端设置！"); toggleCloud(); return; }

        const btn = document.getElementById('btn-cloud');
        btn.innerText = "⏳ 同步中...";
        btn.disabled = true;

        try {
            const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
            const res = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
            if (!res.ok) throw new Error("无法连接 GitHub。");
            const fileData = await res.json();
            const db = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));
            const sha = fileData.sha;

            const newData = JSON.parse(generateJSON(true));
            if (!db.attractions) db.attractions = [];

            const index = db.attractions.findIndex(a => a.id === newData.id);
            if (index > -1) {
                db.attractions[index] = newData;
            } else {
                db.attractions.unshift(newData);
            }

            const updatedBody = btoa(unescape(encodeURIComponent(JSON.stringify(db, null, 2))));
            const putRes = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `Update: ${newData.name} via Work Station`,
                    content: updatedBody,
                    sha: sha
                })
            });

            if (putRes.ok) alert("✅ 云端同步成功！");
            else alert("❌ 云端同步失败。");
        } catch (err) {
            alert("💥 错误: " + err.message);
        } finally {
            btn.innerText = "🚀 云端同步";
            btn.disabled = false;
        }
    }

    async function connectDB() {
        try {
            [fileHandle] = await window.showOpenFilePicker({
                types: [{ description: 'JSON File', accept: { 'application/json': ['.json'] } }],
                multiple: false
            });
            document.getElementById('status-dot').classList.add('active');
            document.getElementById('status-text').innerText = "已关联: " + fileHandle.name;
            document.getElementById('status-text').style.color = "var(--success-color)";
        } catch (e) { console.log("用户取消关联"); }
    }

    async function saveToLocal() {
        if (!fileHandle) { alert("❌ 请先点击【关联本地】"); return; }
        try {
            const newData = JSON.parse(generateJSON(true));
            const file = await fileHandle.getFile();
            const text = await file.text();
            let db = JSON.parse(text);
            if (!db.attractions) db.attractions = [];

            const index = db.attractions.findIndex(a => a.id === newData.id);
            if (index > -1) {
                db.attractions[index] = newData;
            } else {
                db.attractions.unshift(newData);
            }

            const writable = await fileHandle.createWritable();
            await writable.write(JSON.stringify(db, null, 2));
            await writable.close();
            alert("✅ 本地写入成功！");
        } catch (err) { alert("❌ 写入失败。"); }
    }

    function handleCategoryChange() {
        const cat = document.getElementById('nuo-category').value;
        document.getElementById('main-form').style.display = (cat === 'drinks') ? 'none' : 'block';
        document.getElementById('dev-msg').style.display = (cat === 'drinks') ? 'block' : 'none';
        if(cat === 'attractions') { initDims(); updateAll(); }
    }

    function initDims() {
        const container = document.getElementById('dims-container');
        container.innerHTML = '';
        const cfg = CONFIG.attractions;
        for(let i=0; i<4; i++) {
            container.innerHTML += `
                <div class="score-item">
                    <label>${cfg.l[i]} (${cfg.w[i]*100}%)</label>
                    <div class="row">
                        <input type="number" step="0.1" class="in-base" placeholder="基准" oninput="updateAll()">
                        <select class="in-adj" onchange="updateAll()"><option value="0">无</option><option value="0.2">+</option><option value="-0.2">-</option></select>
                        <div class="res-tag">0.0</div>
                    </div>
                </div>`;
        }
    }

    function addTagField() {
        const div = document.createElement('div');
        div.className = 'tag-item';
        div.innerHTML = `<input type="text" placeholder="Tag名" style="flex:2" oninput="updateAll()"><select style="flex:1.5" onchange="updateAll()"><option value="S">S (+0.3)</option><option value="A">A (+0.2)</option><option value="B">B (+0.1)</option><option value="C">C (+0.05)</option></select><button onclick="this.parentElement.remove();updateAll()" style="border:none;background:none;color:#ef4444;cursor:pointer;font-size:24px;line-height:1;">&times;</button>`;
        document.getElementById('tag-list').appendChild(div);
        updateAll();
    }

    function updateAll() {
        const cfg = CONFIG.attractions;
        const items = document.querySelectorAll('.score-item');
        let weightedBase = 0;
        items.forEach((item, i) => {
            const res = (parseFloat(item.querySelector('.in-base').value) || 0) + (parseFloat(item.querySelector('.in-adj').value) || 0);
            item.querySelector('.res-tag').innerText = res.toFixed(1);
            weightedBase += res * cfg.w[i];
        });
        let bonus = 0;
        document.querySelectorAll('.tag-item').forEach(tag => { bonus += TAG_MAP[tag.querySelector('select').value] || 0; });
        const final = weightedBase + bonus;
        document.getElementById('v-base').innerText = weightedBase.toFixed(3);
        document.getElementById('v-final').innerText = final.toFixed(2);
        let lv = "D"; if(final >= 9) lv = "S"; else if(final >= 8) lv = "A"; else if(final >= 7) lv = "B"; else if(final >= 6) lv = "C";
        const dec = final - Math.floor(final);
        if(final >= 6) { if(dec <= 0.25) lv += "-"; else if(dec >= 0.75) lv += "+"; }
        document.getElementById('v-level').innerText = lv;
        generateJSON(true);
    }

    function generateJSON(silent = false) {
        const cfg = CONFIG.attractions;
        const tags = [];
        document.querySelectorAll('.tag-item').forEach(t => {
            const name = t.querySelector('input').value;
            if(name) tags.push({ name: name, tier: t.querySelector('select').value });
        });

        const scoresObj = {};
        document.querySelectorAll('.score-item').forEach((item, i) => {
            const base = item.querySelector('.in-base').value || "0";
            const adj = item.querySelector('.in-adj').value;
            const sym = adj == "0.2" ? "+" : (adj == "-0.2" ? "-" : "");
            scoresObj[cfg.keys[i]] = { text: base + sym, val: parseFloat(item.querySelector('.res-tag').innerText) };
        });

        const rDate = document.getElementById('in-rtime').value || new Date().toLocaleDateString('zh-CN');
        const review = document.getElementById('in-review').value;

        const formattedReview = review.split('\n')
            .filter(p => p.trim())
            .map(p => "\u3000\u3000" + p.trim())
            .join('\n\n');

        const fullReview = "✍️ 记录于: " + rDate + "\n\n" + formattedReview;
        const customId = document.getElementById('in-id').value.trim() || ("nuo-" + Date.now());

        const json = {
            id: customId,
            name: document.getElementById('in-name').value,
            slogan: document.getElementById('in-slogan').value,
            short_review: fullReview,
            images: document.getElementById('in-imgs').value.split('\n')
                .filter(i => i.trim())
                .map(img => {
                    let cleanUrl = img.trim();
                    // 魔法 1：如果粘贴的是 Markdown 格式 ![](https://...)，自动抠出里面的纯链接
                    const mdMatch = cleanUrl.match(/!\[.*?\]\((.*?)\)/);
                    if (mdMatch) cleanUrl = mdMatch[1];
                    
                    // 魔法 2：如果你习惯性只填了 /rate/... 相对路径，自动帮你加上云端域名
                    if (cleanUrl.startsWith('/')) {
                        cleanUrl = 'https://img.1nuo.me' + cleanUrl;
                    }
                    return cleanUrl;
                }),
            location: document.getElementById('in-loc').value,
            visit_time: document.getElementById('in-vtime').value,
            scores: scoresObj,
            tags: tags,
            final_score: parseFloat(document.getElementById('v-final').innerText),
            rating: document.getElementById('v-level').innerText
        };

        const resStr = JSON.stringify(json, null, 2);
        if(!silent) document.getElementById('out-json').value = resStr;
        return resStr;
    }

    const now = new Date();
    document.getElementById('in-rtime').value = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`;
    loadCloudConfig();
    initDims();
    updateAll();
</script>
</body>
</html>